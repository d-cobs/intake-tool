<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eigen Â· Role Intake Tool</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --bg: #0a0a0f; --surface: #111118; --surface2: #18181f;
    --border: #2a2a35; --border-light: #33333f;
    --accent: #6c8fff; --accent2: #a78bfa;
    --text: #e8e8f0; --text-muted: #7a7a90; --text-dim: #4a4a60;
    --green: #4ade80;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; min-height: 100vh; line-height: 1.6; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(108,143,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(108,143,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: 0;
  }
  #setupScreen { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 100; align-items: center; justify-content: center; padding: 24px; }
  .setup-box { max-width: 420px; width: 100%; }
  #mainApp { display: none; }
  .api-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 8px 24px; display: flex; align-items: center; justify-content: flex-end; gap: 12px; position: relative; z-index: 1; }
  .api-bar-label { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text-dim); letter-spacing: 0.06em; text-transform: uppercase; }
  .btn-small { background: transparent; border: 1px solid var(--border); border-radius: 5px; color: var(--text-dim); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.05em; padding: 4px 10px; text-transform: uppercase; transition: all 0.15s; }
  .btn-small:hover { color: var(--text-muted); border-color: var(--border-light); }
  .container { position: relative; z-index: 1; max-width: 820px; margin: 0 auto; padding: 48px 24px 80px; }
  .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
  .logo-mark { width: 28px; height: 28px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 500; color: white; letter-spacing: -0.5px; }
  .logo-text { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase; }
  h1 { font-size: 26px; font-weight: 400; letter-spacing: -0.5px; margin-bottom: 8px; }
  .subtitle { color: var(--text-muted); font-size: 14px; font-weight: 300; margin-bottom: 24px; }
  /* Google bar */
  .google-bar { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px 18px; margin-bottom: 28px; display: flex; align-items: center; justify-content: space-between; gap: 12px; transition: border-color 0.2s; }
  .google-bar.connected { border-color: rgba(74,222,128,0.3); background: rgba(74,222,128,0.04); }
  .gbar-left { display: flex; align-items: center; gap: 10px; }
  .gdot { width: 7px; height: 7px; border-radius: 50%; background: var(--border); flex-shrink: 0; transition: background 0.2s; }
  .gdot.on { background: var(--green); animation: pulse 2s ease infinite; }
  .gbar-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-dim); }
  .gbar-user { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--green); margin-top: 2px; }
  .btn-gsign { display: inline-flex; align-items: center; gap: 8px; background: white; border: none; border-radius: 6px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; color: #1a1a1a; padding: 7px 14px; transition: opacity 0.15s; white-space: nowrap; }
  .btn-gsign:hover { opacity: 0.9; }
  /* Form */
  .form-grid { display: grid; gap: 20px; margin-bottom: 24px; }
  .field { display: flex; flex-direction: column; gap: 8px; }
  label { font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
  .required { color: var(--accent); font-size: 9px; }
  textarea, input[type="text"], select { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13.5px; font-weight: 300; line-height: 1.6; padding: 14px 16px; resize: vertical; transition: border-color 0.15s, box-shadow 0.15s; width: 100%; outline: none; }
  textarea:focus, input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(108,143,255,0.08); }
  textarea::placeholder, input::placeholder { color: var(--text-dim); font-style: italic; }
  textarea { min-height: 120px; } textarea.tall { min-height: 160px; }
  select option { background: var(--surface2); }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .divider { height: 1px; background: var(--border); margin: 8px 0 4px; opacity: 0.5; }
  .section-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 16px; margin-top: 8px; }
  .btn-generate { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border: none; border-radius: 8px; color: white; font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; letter-spacing: 0.05em; cursor: pointer; transition: opacity 0.15s, transform 0.1s; }
  .btn-generate:hover { opacity: 0.9; } .btn-generate:active { transform: scale(0.99); } .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-inner { display: flex; align-items: center; justify-content: center; gap: 8px; }
  .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
  .spinner.active { display: block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .error-box { background: #1a0f0f; border: 1px solid #3a1f1f; border-radius: 8px; padding: 16px 20px; color: #f87171; font-size: 13px; margin-top: 16px; display: none; }
  .error-box.visible { display: block; }
  /* Output */
  .output-section { margin-top: 32px; display: none; }
  .output-section.visible { display: block; }
  .output-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--green); display: flex; align-items: center; gap: 6px; margin-bottom: 20px; }
  .output-label::before { content: ''; width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 2s ease infinite; }
  .tabs { display: flex; gap: 4px; margin-bottom: 16px; }
  .tab { padding: 8px 20px; border-radius: 6px; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; border: 1px solid var(--border); background: transparent; color: var(--text-dim); transition: all 0.15s; }
  .tab:hover { color: var(--text-muted); border-color: var(--border-light); }
  .tab.active { background: var(--surface2); border-color: var(--accent); color: var(--accent); }
  .tab-content { display: none; } .tab-content.active { display: block; }
  .doc-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .doc-card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .doc-card-title { font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); }
  .action-btns { display: flex; gap: 8px; align-items: center; }
  .btn-action { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.06em; padding: 6px 12px; text-transform: uppercase; transition: all 0.15s; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; }
  .btn-action:hover { border-color: var(--accent); color: var(--accent); }
  .btn-action.success { border-color: var(--green); color: var(--green); }
  .btn-action.primary { background: rgba(108,143,255,0.1); border-color: var(--accent); color: var(--accent); }
  .btn-action.creating { opacity: 0.5; pointer-events: none; }
  .doc-body { padding: 28px 32px; font-family: 'DM Sans', sans-serif; font-size: 13.5px; font-weight: 300; line-height: 1.8; color: var(--text); white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
  .doc-body::-webkit-scrollbar { width: 4px; } .doc-body::-webkit-scrollbar-track { background: transparent; } .doc-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .doc-footer { padding: 10px 20px; border-top: 1px solid var(--border); font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text-dim); }
  .mini-spinner { width: 10px; height: 10px; border: 1.5px solid rgba(108,143,255,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
  .bottom-actions { display: flex; gap: 10px; margin-top: 16px; }
  .btn-secondary { flex: 1; padding: 11px; background: transparent; border: 1px solid var(--border); border-radius: 7px; color: var(--text-muted); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.05em; text-transform: uppercase; transition: all 0.15s; }
  .btn-secondary:hover { border-color: var(--border-light); color: var(--text); }
</style>
</head>
<body>

<!-- Main App -->
<div id="mainApp">


  <div class="container">
    <div class="logo"><div class="logo-mark">EL</div><span class="logo-text">Eigen Labs Â· Talent</span></div>
    <h1>Role Intake Tool</h1>
    <p class="subtitle">Fill in 5 things. AI generates your intake form + JD â€” straight into Google Docs.</p>

    <!-- Google sign-in bar -->
    <div class="google-bar" id="googleBar">
      <div class="gbar-left">
        <div class="gdot" id="gDot"></div>
        <div>
          <div class="gbar-label" id="gBarLabel">Connect Google to auto-create Docs in Drive</div>
          <div class="gbar-user" id="gBarUser" style="display:none;"></div>
        </div>
      </div>
      <button class="btn-gsign" id="gSignBtn" onclick="googleSignIn()">
        <svg width="16" height="16" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/></svg>
        Sign in with Google
      </button>
      <button class="btn-small" id="gSignOutBtn" style="display:none;" onclick="googleSignOut()">Sign out</button>
    </div>

    <div class="form-grid">
      <div class="section-label">â€” Role Details</div>
      <div class="two-col">
        <div class="field">
          <label>Role Title <span class="required">required</span></label>
          <input type="text" id="roleTitle" placeholder="e.g. People Ops Generalist" />
        </div>
        <div class="field">
          <label>Level <span class="required">required</span></label>
          <select id="roleLevel">
            <option value="" disabled selected>Select level</option>
            <option>IC1</option><option>IC2</option><option>IC3</option><option>IC4</option><option>IC5</option>
            <option>Manager</option><option>Senior Manager</option><option>Director</option><option>VP</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Location <span class="required">required</span></label>
        <input type="text" id="location" placeholder="e.g. Seattle (in-office), Remote, Hybrid - NYC" />
      </div>
      <div class="divider"></div>
      <div class="section-label">â€” The Role</div>
      <div class="field">
        <label>What Will They Own <span class="required">required</span></label>
        <textarea id="ownership" class="tall" placeholder="Bullet points are fine. Even 2-3 rough ideas â€” AI will expand into a full picture based on the title and level."></textarea>
      </div>
      <div class="field">
        <label>Why Are We Hiring Now <span class="required">required</span></label>
        <textarea id="whyNow" placeholder="Backfill? New function? What slows down or breaks if we don't hire?"></textarea>
      </div>
      <div class="field">
        <label>What Makes This Role Exciting <span class="required">required</span></label>
        <textarea id="excitement" placeholder="Elevator pitch for a strong candidate. How does this role evolve? What's the impact?"></textarea>
      </div>
    </div>

    <button class="btn-generate" id="generateBtn" onclick="generate()">
      <div class="btn-inner">
        <div class="spinner" id="spinner"></div>
        <span id="btnText">Generate Intake Form + JD</span>
      </div>
    </button>
    <div class="error-box" id="errorBox"></div>

    <div class="output-section" id="outputSection">
      <div class="output-label">Ready</div>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('intake', this)">ðŸ“‹ Intake Form</button>
        <button class="tab" onclick="switchTab('jd', this)">ðŸ“„ Job Description</button>
        <button class="tab" onclick="switchTab('clarity', this)">ðŸŽ¯ Role Clarity</button>
      </div>

      <div class="tab-content active" id="tab-intake">
        <div class="doc-card">
          <div class="doc-card-header">
            <span class="doc-card-title">Intake Form</span>
            <div class="action-btns">
              <span id="intakeDocStatus"></span>
              <button class="btn-action" id="copyIntakeBtn" onclick="copyDoc('intake')">Copy</button>
            </div>
          </div>
          <div class="doc-body" id="intakeBody"></div>
        </div>
      </div>

      <div class="tab-content" id="tab-jd">
        <div class="doc-card">
          <div class="doc-card-header">
            <span class="doc-card-title">Job Description</span>
            <div class="action-btns">
              <span id="jdDocStatus"></span>
              <button class="btn-action" id="copyJdBtn" onclick="copyDoc('jd')">Copy</button>
            </div>
          </div>
          <div class="doc-body" id="jdBody"></div>
        </div>
      </div>

      <div class="tab-content" id="tab-clarity">
        <div class="doc-card">
          <div class="doc-card-header">
            <span class="doc-card-title">Role Clarity</span>
            <div class="action-btns">
              <span id="clarityDocStatus"></span>
              <button class="btn-action" id="copyClarityBtn" onclick="copyDoc('clarity')">Copy</button>
            </div>
          </div>
          <div class="doc-body" id="clarityBody"></div>
        </div>
      </div>

      <div class="bottom-actions">
        <button class="btn-secondary" onclick="generate()">â†º Regenerate</button>
        <button class="btn-secondary" onclick="clearForm()">â†’ New Role</button>
      </div>
    </div>
  </div>
</div>

<script>
const GOOGLE_CLIENT_ID = '43372069307-7ml5b9p8vo2glakd45aplb2f2pctnmsk.apps.googleusercontent.com';
const GDOCS_SCOPE = 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file';

let gAccessToken = null;
let gTokenClient = null;
let intakeText = '';
let jdText = '';
let clarityText = '';
let lastIntakeData = null;
let lastInputs = null;

// â”€â”€ API Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getApiKey() { return 'AIzaSyDpUmjEJdXa8TA76620DAjZyZmEEyJlQ-s'; }
function showApp() { document.getElementById('mainApp').style.display = 'block'; }

// â”€â”€ Google Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  showApp();
  // Init Google token client once GSI loads
  const interval = setInterval(() => {
    if (window.google && window.google.accounts) {
      clearInterval(interval);
      gTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: GDOCS_SCOPE,
        callback: handleGoogleToken
      });
    }
  }, 300);
});

async function handleGoogleToken(resp) {
  if (resp.error) { console.error('Google auth error:', resp.error); return; }
  gAccessToken = resp.access_token;
  try {
    const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { Authorization: 'Bearer ' + gAccessToken } });
    const info = await r.json();
    setGoogleUI(true, info.email || 'Connected');
  } catch(e) { setGoogleUI(true, 'Connected'); }
}

function googleSignIn() {
  if (!gTokenClient) { alert('Google is still loading â€” please try again in a moment.'); return; }
  gTokenClient.requestAccessToken();
}

function googleSignOut() {
  if (gAccessToken) google.accounts.oauth2.revoke(gAccessToken, () => {});
  gAccessToken = null;
  setGoogleUI(false);
}

function setGoogleUI(connected, email) {
  const bar = document.getElementById('googleBar');
  const dot = document.getElementById('gDot');
  const label = document.getElementById('gBarLabel');
  const user = document.getElementById('gBarUser');
  const signBtn = document.getElementById('gSignBtn');
  const signOutBtn = document.getElementById('gSignOutBtn');
  if (connected) {
    bar.classList.add('connected');
    dot.classList.add('on');
    label.textContent = 'Google Docs connected';
    user.textContent = email;
    user.style.display = 'block';
    signBtn.style.display = 'none';
    signOutBtn.style.display = 'inline-flex';
  } else {
    bar.classList.remove('connected');
    dot.classList.remove('on');
    label.textContent = 'Connect Google to auto-create Docs in Drive';
    user.style.display = 'none';
    signBtn.style.display = 'inline-flex';
    signOutBtn.style.display = 'none';
  }
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

// â”€â”€ Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generate() {
  const apiKey = getApiKey();

  const roleTitle  = document.getElementById('roleTitle').value.trim();
  const roleLevel  = document.getElementById('roleLevel').value;
  const location   = document.getElementById('location').value.trim();
  const ownership  = document.getElementById('ownership').value.trim();
  const whyNow     = document.getElementById('whyNow').value.trim();
  const excitement = document.getElementById('excitement').value.trim();

  const errorBox = document.getElementById('errorBox');
  errorBox.classList.remove('visible');

  if (!roleTitle || !roleLevel || !location || !ownership || !whyNow || !excitement) {
    errorBox.textContent = 'Please fill in all fields.'; errorBox.classList.add('visible'); return;
  }

  const btn = document.getElementById('generateBtn');
  const spinner = document.getElementById('spinner');
  const btnText = document.getElementById('btnText');

  btn.disabled = true; spinner.classList.add('active'); btnText.textContent = 'Generating...';
  document.getElementById('intakeDocStatus').innerHTML = '';
  document.getElementById('jdDocStatus').innerHTML = '';
  document.getElementById('clarityDocStatus').innerHTML = '';

  const COMPETENCIES = `
EIGEN LABS CORE COMPETENCIES (use ONLY these â€” exact names and questions)

1. Own & Deliver (Ownership)
   Q1: Walk me through a project you owned end-to-end. How did you ensure it was successful?
   Q2: Tell me about a time when you took on something significant outside your area of responsibility. Why was that important, and what was the impact?
   Q3: Tell me about a time you worked to improve the quality of a product/service already seen as good enough.

2. Go All In (Insist on the Highest Standards)
   Q1: Walk me through a project you owned end-to-end. How did you ensure it was successful?
   Q2: Tell me about a time when you took on something significant outside your area of responsibility. Why was that important, and what was the impact?
   Q3: Tell me about a time you worked to improve the quality of a product/service already seen as good enough.

3. Build Enduring Trust (Earn Trust & Be Bold)
   Q1: Tell me about a time you improved a product, system, or process that was already performing well. What drove you to make it better, and what was the outcome?
   Q2: Tell me about a time you missed a target. What did you learn, and how did you adjust your approach to ensure better results next time?
   Q3: Tell me about a time you saw a process or deliverable that didn't meet your standards. What did you do? Did he or she respond?

4. Think First Principles (Navigating Ambiguity)
   Q1: Tell me about a time you had to communicate a big change in direction for which you anticipated people would have a lot of concerns. How did you handle questions and/or resistance? Were you able to get people comfortable with the change?
   Q2: Tell me about a piece of direct feedback you recently gave to a colleague. How did he or she respond?
   Q3: Tell me about a time you disagreed with a project direction but ultimately went forward as company planned.

5. Iterate Rapidly (Learn & Be Curious)
   Q1: Tell me about a time you taught or shared something that unlocked progress for others.
   Q2: Tell me about feedback you've received that was hard to hear. How did you respond?
   Q3: Give me an example of when your curiosity uncovered a better way of doing things.

RULES: HM always covers Own & Deliver. Pick 2 other competencies most relevant to this role for Team Interviews. Quote the best question exactly.`;

  const intakePrompt = `You are a senior talent partner at Eigen Labs. A hiring manager submitted initial notes â€” treat as a starting point, not a complete spec. Silently fix any typos or grammar errors in their input.

Use the title, level, and context to fill gaps and produce a comprehensive intake form. Draw on your knowledge of how this function works at 50-100 person tech startups. Don't echo HM input back â€” expand it.

Role Title: ${roleTitle}
Level: ${roleLevel}
Location: ${location}
HM's ownership notes (starting point only): ${ownership}
Why hiring now: ${whyNow}
What makes it exciting: ${excitement}

About Eigen: 60-person crypto/AI startup, EigenCloud + EigenLayer, backed by a16z, high-trust high-ownership culture.

${COMPETENCIES}

Respond ONLY with valid JSON, no markdown, no code fences:
{
  "expandedOwnership": ["fleshed-out ownership area 1", "area 2", "area 3", "area 4", "area 5", "area 6"],
  "mustHaveSkills": ["1. Skill: description of what good looks like", "2. Skill: description", "3. Skill: description", "4. Skill: description", "5. Skill: description"],
  "coreCompetencies": ["exact competency name 1", "exact competency name 2", "exact competency name 3"],
  "internalBusinessCase": "2-3 sentences on why Eigen needs this now",
  "elevatorPitch": "3-4 compelling sentences for candidates",
  "interviewStructure": [
    { "stage": "Recruiter Screen (Danielle)", "goal": "Culture fit, baseline experience, motivation" },
    { "stage": "HM Interview", "competency": "Own & Deliver (Ownership)", "question": "exact question from Own & Deliver most relevant to this role" },
    { "stage": "Team Interview 1", "competency": "exact competency name", "question": "exact question from that competency" },
    { "stage": "Team Interview 2", "competency": "exact competency name", "question": "exact question from that competency" },
    { "stage": "Presentation / Work Trial", "goal": "specific 1-2 hour work trial prompt for this role" }
  ]
}`;

  const jdPrompt = `You are a senior talent partner at Eigen Labs writing a job description. Use the HM's notes as seeds â€” silently fix any typos â€” and write a complete, compelling JD. Think about what the best JDs for this role at companies like Stripe, Linear, or Notion look like. Expand beyond the HM's bullet points.

Role Title: ${roleTitle}
Level: ${roleLevel}
Location: ${location}
HM's ownership notes: ${ownership}
Why hiring: ${whyNow}
What makes it exciting: ${excitement}

Respond ONLY with valid JSON, no markdown, no code fences:
{
  "theRole": "2-3 paragraphs. Compelling and specific â€” what is this person's mandate at Eigen? Write for a strong candidate who has options.",
  "whatYouWillDo": [
    { "title": "Section Title e.g. Onboarding & Employee Lifecycle Management", "bullet": "Full description sentence starting with a verb e.g. Own and continuously improve the end-to-end employee lifecycle, including onboarding, performance management, role transitions, and offboarding. Ensure a seamless, compliant, and human-centered experience at every stage." },
    { "title": "Section Title", "bullet": "description" },
    { "title": "Section Title", "bullet": "description" },
    { "title": "Section Title", "bullet": "description" },
    { "title": "Section Title", "bullet": "description" },
    { "title": "Section Title", "bullet": "description" }
  ],
  "whatYouWillBring": [
    { "title": "Category e.g. Experience", "bullet": "Full sentence e.g. 2-4 years of experience in People Operations, HR, or a similar role, with exposure to core People processes across the employee lifecycle." },
    { "title": "Category", "bullet": "description" },
    { "title": "Category", "bullet": "description" },
    { "title": "Category", "bullet": "description" }
  ]
}`;

  try {
    const clarityPrompt = `You are helping draft a quarterly Role Clarity doc for a new hire at Eigen Labs. Based on the role details below, draft answers to the three questions. These are starting points â€” mark each with [DRAFT] at the start since they will be reviewed and personalized.

Role Title: ${roleTitle}
Level: ${roleLevel}
What they own: ${ownership}
Why we're hiring: ${whyNow}

Keep each answer concise â€” 2-4 sentences max. Write in second person ("You own...", "Your work creates..."). Be specific to this role, not generic.

Respond ONLY with valid JSON, no markdown, no code fences:
{
  "whatYouOwn": "[DRAFT] You own...",
  "whatYouContribute": "[DRAFT] Your work creates...",
  "topPriority": "[DRAFT] The most important thing for you to accomplish this quarter is..."
}`;

    const [intakeRaw, jdRaw, clarityRaw] = await Promise.all([
      callGemini(intakePrompt, apiKey),
      callGemini(jdPrompt, apiKey),
      callGemini(clarityPrompt, apiKey)
    ]);

    let intake, jd, clarity;
    try { intake = JSON.parse(intakeRaw); } catch(e) { throw new Error('Could not parse intake response â€” please try again.'); }
    try { jd = JSON.parse(jdRaw); } catch(e) { throw new Error('Could not parse JD response â€” please try again.'); }
    try { clarity = JSON.parse(clarityRaw); } catch(e) { clarity = { whatYouOwn: '[DRAFT] Review and complete.', whatYouContribute: '[DRAFT] Review and complete.', topPriority: '[DRAFT] Review and complete.' }; }

    intakeText = buildIntakeText(intake, { roleTitle, roleLevel, location, ownership });
    jdText = buildJdText(jd, { roleTitle, roleLevel, location });
    clarityText = buildClarityText(clarity, { roleTitle });
    lastIntakeData = intake;
    lastInputs = { roleTitle, roleLevel, location, ownership };

    document.getElementById('intakeBody').textContent = intakeText;
    document.getElementById('jdBody').textContent = jdText;
    document.getElementById('clarityBody').textContent = clarityText;
    document.getElementById('outputSection').classList.add('visible');
    document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // If Google connected, auto-create docs
    if (gAccessToken) {
      createGoogleDocs(roleTitle, roleLevel);
    }

  } catch(err) {
    errorBox.textContent = err.message; errorBox.classList.add('visible');
  } finally {
    btn.disabled = false; spinner.classList.remove('active'); btnText.textContent = 'Generate Intake Form + JD';
  }
}

async function callGemini(prompt, apiKey) {
  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
    { method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.7, maxOutputTokens: 3000 } }) }
  );
  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    if (response.status === 400 || response.status === 403) throw new Error('Invalid API key â€” click "Change Key" to update.');
    throw new Error(err?.error?.message || `API error: ${response.status}`);
  }
  const data = await response.json();
  let text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
  if (!text) throw new Error('No response returned â€” please try again.');
  return text.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim();
}

// â”€â”€ Google Docs creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createGoogleDocs(roleTitle, roleLevel) {
  const intakeStatus = document.getElementById('intakeDocStatus');
  const jdStatus = document.getElementById('jdDocStatus');
  const clarityStatus = document.getElementById('clarityDocStatus');

  const loading = `<span class="btn-action creating" style="gap:6px;"><span class="mini-spinner"></span>Creating...</span>`;
  intakeStatus.innerHTML = loading;
  jdStatus.innerHTML = loading;
  clarityStatus.innerHTML = loading;

  try {
    const [intakeUrl, jdUrl, clarityUrl] = await Promise.all([
      createStructuredIntakeDoc(`Intake Form â€” ${roleTitle} (${roleLevel})`, lastIntakeData, lastInputs),
      createGoogleDoc(`JD Draft â€” ${roleTitle}`, jdText),
      createGoogleDoc(`Role Clarity â€” ${roleTitle}`, clarityText)
    ]);
    intakeStatus.innerHTML = `<a href="${intakeUrl}" target="_blank" class="btn-action primary">Open in Docs â†—</a>`;
    jdStatus.innerHTML = `<a href="${jdUrl}" target="_blank" class="btn-action primary">Open in Docs â†—</a>`;
    clarityStatus.innerHTML = `<a href="${clarityUrl}" target="_blank" class="btn-action primary">Open in Docs â†—</a>`;
  } catch(err) {
    intakeStatus.innerHTML = '';
    jdStatus.innerHTML = '';
    clarityStatus.innerHTML = '';
    console.error('Google Docs error:', err);
  }
}

async function createGoogleDoc(title, body) {
  const createResp = await fetch('https://docs.googleapis.com/v1/documents', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + gAccessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify({ title })
  });
  if (!createResp.ok) throw new Error('Could not create doc');
  const doc = await createResp.json();
  const docId = doc.documentId;
  await fetch(`https://docs.googleapis.com/v1/documents/${docId}:batchUpdate`, {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + gAccessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify({ requests: [{ insertText: { location: { index: 1 }, text: body } }] })
  });
  return `https://docs.google.com/document/d/${docId}/edit`;
}

// Build a batchUpdate requests array for a structured intake doc
function buildIntakeRequests(intake, inputs) {
  const reqs = [];
  let cursor = 1;

  function txt(text, opts = {}) {
    if (!text) return;
    reqs.push({ insertText: { location: { index: cursor }, text } });
    const style = {};
    if (opts.bold) style.bold = true;
    if (opts.size) style.fontSize = { magnitude: opts.size, unit: 'PT' };
    if (opts.color) style.foregroundColor = { color: { rgbColor: opts.color } };
    style.weightedFontFamily = { fontFamily: 'Arial' };
    const fields = ['weightedFontFamily', opts.bold ? 'bold' : null, opts.size ? 'fontSize' : null, opts.color ? 'foregroundColor' : null].filter(Boolean).join(',');
    reqs.push({ updateTextStyle: {
      range: { startIndex: cursor, endIndex: cursor + text.length },
      textStyle: style, fields
    }});
    cursor += text.length;
  }

  function para(text, opts = {}) { txt(text + '\n', opts); }
  function blank() { para(''); }

  function sectionHeader(label) {
    para(label, { bold: true, size: 10, color: { red: 0.2, green: 0.2, blue: 0.2 } });
  }

  function row(label, value) {
    txt(label + '\t', { bold: true, size: 9 });
    para(value || '', { size: 9 });
  }

  function bulletList(items) {
    (items || []).forEach(item => {
      para('â€¢ ' + (typeof item === 'object' ? Object.values(item).join(': ') : item), { size: 9 });
    });
  }

  // â”€â”€ WHO, WHAT & WHERE â”€â”€
  sectionHeader('WHO, WHAT & WHERE');
  row('Role Title', inputs.roleTitle);
  row('Level', inputs.roleLevel);
  row('Location', inputs.location);
  row('Hiring Manager', '');
  row('Team', '');
  row('Link to JD', '');
  blank();

  // â”€â”€ WHY â”€â”€
  sectionHeader('WHY');
  row('Internal Business Case', intake.internalBusinessCase || '');
  blank();
  para('What Will They Own', { bold: true, size: 9 });
  bulletList(intake.expandedOwnership || []);
  blank();
  row('Elevator Pitch', intake.elevatorPitch || '');
  blank();
  row('Preferred Backgrounds / Companies', '');
  row('3 Referrals / Example Candidates', '');
  blank();

  // â”€â”€ SKILLS & COMPETENCIES â”€â”€
  sectionHeader('SKILLS & COMPETENCIES');
  para('Top 5 Must-Have Skills', { bold: true, size: 9 });
  (intake.mustHaveSkills || []).forEach(s => {
    const str = typeof s === 'object' ? Object.values(s).join(': ') : s;
    // Split on first colon to bold the label
    const colonIdx = str.indexOf(':');
    if (colonIdx > 0) {
      txt(str.slice(0, colonIdx + 1), { bold: true, size: 9 });
      para(str.slice(colonIdx + 1).trim(), { size: 9 });
    } else {
      para(str, { size: 9 });
    }
  });
  blank();
  para('Core Competencies', { bold: true, size: 9 });
  (intake.coreCompetencies || []).forEach((c, i) => {
    para((i + 1) + '. ' + c, { size: 9 });
  });
  blank();

  // â”€â”€ HOW â”€â”€
  sectionHeader('HOW');
  // Table header
  txt('Stage', { bold: true, size: 9 }); txt('\t', { size: 9 });
  txt('Who', { bold: true, size: 9 }); txt('\t', { size: 9 });
  txt('Goal', { bold: true, size: 9 }); txt('\t', { size: 9 });
  para('Competency / Question', { bold: true, size: 9 });

  (intake.interviewStructure || []).forEach(s => {
    if (s.stage && s.stage.includes('Recruiter')) {
      txt(s.stage, { size: 9 }); txt('\t', { size: 9 });
      txt('Recruiter', { size: 9 }); txt('\t', { size: 9 });
      txt(s.goal || '', { size: 9 }); txt('\t', { size: 9 });
      para('â€”', { size: 9 });
    } else if (s.competency && s.question) {
      txt(s.stage, { size: 9 }); txt('\t', { size: 9 });
      txt('Hiring Manager', { size: 9 }); txt('\t', { size: 9 });
      txt('Assess ' + s.competency, { size: 9 }); txt('\t', { size: 9 });
      para(s.question, { size: 9 });
    } else if (s.stage && s.stage.includes('Work Trial')) {
      txt(s.stage, { size: 9 }); txt('\t', { size: 9 });
      txt('Hiring Committee', { size: 9 }); txt('\t', { size: 9 });
      txt('', { size: 9 }); txt('\t', { size: 9 });
      para(s.goal || '', { size: 9 });
    }
  });

  blank();
  para('Generated by Eigen Labs Talent Tool Â· Review before sharing', { size: 8, color: { red: 0.6, green: 0.6, blue: 0.6 } });

  return reqs;
}

async function createStructuredIntakeDoc(title, intake, inputs) {
  const createResp = await fetch('https://docs.googleapis.com/v1/documents', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + gAccessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify({ title })
  });
  if (!createResp.ok) throw new Error('Could not create intake doc');
  const doc = await createResp.json();
  const docId = doc.documentId;

  const requests = buildIntakeRequests(intake, inputs);

  // Set narrow margins for compact layout
  requests.push({
    updateDocumentStyle: {
      documentStyle: {
        marginTop: { magnitude: 36, unit: 'PT' },
        marginBottom: { magnitude: 36, unit: 'PT' },
        marginLeft: { magnitude: 54, unit: 'PT' },
        marginRight: { magnitude: 54, unit: 'PT' }
      },
      fields: 'marginTop,marginBottom,marginLeft,marginRight'
    }
  });

  await fetch(`https://docs.googleapis.com/v1/documents/${docId}:batchUpdate`, {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + gAccessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify({ requests })
  });

  return `https://docs.google.com/document/d/${docId}/edit`;
}

// â”€â”€ Build text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flatStr(r) { return typeof r === 'object' ? Object.values(r).join(': ') : r; }

function flatStr(r) {
  if (typeof r !== 'object' || r === null) return String(r);
  const keys = Object.keys(r);
  if (keys.length >= 2) return r[keys[0]] + ': ' + r[keys[1]];
  return Object.values(r).join(': ');
}

function buildIntakeText(d, inputs) {
  const stages = (d.interviewStructure || []).map(s => {
    if (s.stage && s.stage.includes('Recruiter')) {
      return s.stage + '    Recruiter    ' + (s.goal || '') + '    â€”';
    } else if (s.competency && s.question) {
      return s.stage + '    Hiring Manager    Assess ' + s.competency + '    ' + s.question;
    } else {
      return s.stage + '    Hiring Committee    ' + (s.goal || '');
    }
  }).join('\n');

  const lines = [
    'WHO, WHAT & WHERE',
    'Role Title    ' + inputs.roleTitle,
    'Level    ' + inputs.roleLevel,
    'Location    ' + inputs.location,
    'Hiring Manager    ',
    'Team    ',
    'Link to JD    ',
    '',
    'WHY',
    'Internal Business Case    ' + (d.internalBusinessCase || ''),
    '',
    'What Will They Own',
    ...(d.expandedOwnership || []).map(o => 'â€¢ ' + (typeof o === 'object' ? Object.values(o).join(': ') : o)),
    '',
    'Elevator Pitch    ' + (d.elevatorPitch || ''),
    '',
    'Preferred Backgrounds / Companies    ',
    '3 Referrals / Example Candidates    ',
    '',
    'SKILLS & COMPETENCIES',
    'Top 5 Must-Have Skills',
    ...(d.mustHaveSkills || []).map(s => {
      const str = typeof s === 'object' ? Object.values(s).join(': ') : String(s);
      return str;
    }),
    '',
    'Core Competencies',
    ...(d.coreCompetencies || []).map((c, i) => (i + 1) + '. ' + c),
    '',
    'HOW',
    'Stage    Who    Goal    Competency / Question',
    stages,
    '',
    'Generated by Eigen Labs Talent Tool Â· Review before sharing'
  ];
  return lines.join('\n');
}

function buildJdText(d, inputs) {
  const doItems = (d.whatYouWillDo || []).map(r => {
    if (typeof r === 'object' && r !== null) {
      const title = r.title || Object.values(r)[0] || '';
      const desc = r.bullet || r.description || Object.values(r)[1] || '';
      return title + '\nâ€¢ ' + desc;
    }
    const s = String(r);
    const ci = s.indexOf(':');
    if (ci > 0) return s.slice(0, ci + 1) + '\nâ€¢ ' + s.slice(ci + 1).trim();
    return s;
  }).join('\n\n');

  const bringItems = (d.whatYouWillBring || []).map(r => {
    if (typeof r === 'object' && r !== null) {
      const title = r.title || Object.values(r)[0] || '';
      const desc = r.bullet || r.description || Object.values(r)[1] || '';
      return title + '\nâ€¢ ' + desc;
    }
    const s = String(r);
    const ci = s.indexOf(':');
    if (ci > 0) return s.slice(0, ci + 1) + '\nâ€¢ ' + s.slice(ci + 1).trim();
    return s;
  }).join('\n\n');

  return [
    'Eigen Labs is building the infrastructure for a more trustworthy internet.',
    "Today\'s digital world runs on trust-me promises: \"Trust that this AI model is giving you unbiased results.\" \"Trust that this platform isn\'t manipulating your feed.\" \"Trust that this service will honor its commitments.\" These trust assumptions create massive friction and limit what\'s possible online.",
    'EigenCloud changes this by making any digital service verifiable. Built on our EigenLayer protocol, which has attracted billions in economic security, EigenCloud lets developers build applications with mathematical trust guarantees instead of pinky promises.',
    'For developers, this means the best of both worlds: Use familiar cloud tools and programming environments while gaining blockchain-level verifiability. No need to rewrite your application in specialized blockchain languages or accept the limitations of smart contract environments.',
    'For the world, this unlocks transformative applications:',
    'â€¢ AI systems with economic accountability for their outputs',
    'â€¢ Social platforms with verifiable, manipulation-resistant algorithms',
    'â€¢ Prediction markets that can resolve on any real-world event',
    'â€¢ Financial services with cryptographic transparency',
    'â€¢ Any application where trust and correctness matter',
    "We\'re moving beyond crypto\'s current focus on digital money to make all digital interactions more trustworthy. With the fastest-growing developer ecosystem in crypto and backing from top-tier investors, we\'re at the inflection point where verifiable computing goes mainstream.",
    'Ready to build the trust layer for the internet? We\'re looking for builders who want to solve hard problems and create technology that makes the digital world fundamentally more reliable.',
    'This is a full-time position that is located in ' + inputs.location + ' with an in-office requirement.',
    '',
    'THE ROLE',
    d.theRole || '',
    '',
    'WHAT YOU WILL DO',
    '',
    doItems,
    '',
    'WHAT YOU WILL BRING',
    '',
    bringItems,
    '',
    'The target base salary for this role will range between $[X] to $[Y] USD. This is determined by a few factors including your skillset, prior relevant experience, quality of interviews and market factors at the point in time of offer. Other rewards may include short- and long-term incentives, and program-specific awards. In addition, Eigen Labs provides various employee benefits, including:',
    '',
    'Benefits',
    'â€¢ Competitive salary and equity (tokens and options)',
    'â€¢ Comprehensive insurance (medical/dental/vision)',
    'â€¢ Stipend for your ideal remote set-up',
    'â€¢ Flexible hours and a supportive remote environment',
    'â€¢ Unlimited vacation: Take time when you need it (and we really mean it!)',
    'â€¢ 401(k) retirement plan',
    'â€¢ Monthly wellness benefit',
    'â€¢ Yearly off-sites',
    '',
    'Equal Opportunity Employment',
    "There\'s one more, very important thing. We are an equal opportunity employer. We search for amazing people of diverse backgrounds, experiences, abilities, and perspectives. We take care of each other to create an inclusive work environment where we love to come to work every day. We hope you can join us."
  ].join('\n');
}

function buildClarityText(d, inputs) {
  const now = new Date();
  const quarter = 'Q' + Math.ceil((now.getMonth() + 1) / 3) + '-' + now.getFullYear();
  return [
    'Role Clarity',
    inputs.roleTitle,
    quarter,
    '',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    '',
    'What you Own',
    'The specific areas, outcomes, and/or functions you are directly responsible for.',
    '',
    d.whatYouOwn || '[DRAFT] Review and complete.',
    '',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    '',
    'What you Contribute',
    'The unique value your work creates for the company and your teammates.',
    '',
    d.whatYouContribute || '[DRAFT] Review and complete.',
    '',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    '',
    'Your Top Priority',
    'The most important thing for you to get done in the remainder of ' + quarter + '.',
    '',
    d.topPriority || '[DRAFT] Review and complete.',
    '',
    'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
    '[DRAFT] â€” Review and personalize before sharing.'
  ].join('\n');
}

function copyDoc(type) {
  const text = type === 'intake' ? intakeText : type === 'jd' ? jdText : clarityText;
  const btnId = type === 'intake' ? 'copyIntakeBtn' : type === 'jd' ? 'copyJdBtn' : 'copyClarityBtn';
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById(btnId);
    const orig = btn.textContent;
    btn.textContent = 'Copied âœ“'; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
  });
}

// â”€â”€ Clear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearForm() {
  ['roleTitle','location','ownership','whyNow','excitement'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('roleLevel').value = '';
  document.getElementById('outputSection').classList.remove('visible');
  document.getElementById('errorBox').classList.remove('visible');
  document.getElementById('intakeDocStatus').innerHTML = '';
  document.getElementById('jdDocStatus').innerHTML = '';
  document.getElementById('clarityDocStatus').innerHTML = '';
  intakeText = ''; jdText = ''; clarityText = '';
  document.getElementById('roleTitle').focus();
}
</script>
</body>
</html>
